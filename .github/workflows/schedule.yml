name: Scheduled Tests

on:
  push:
    tags:
      - release-test
      - master-test
  schedule:
    # 10 pm (UTC+8) every day for staging
    - cron: "0 14 * * *"
    # 12 am (UTC+8) every day for production
    # - cron: "0 16 * * *"

jobs:
  roo-staging-tests:
    permissions: write-all
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' && github.event.schedule == '0 14 * * *' ||
      github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/release-test') || startsWith(github.ref, 'refs/tags/master-test'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract PR info from tag
        if: github.event_name == 'push'
        run: |
          git fetch --tags --force
          echo "Git tags:"
          git tag
          echo "Attempting to extract PR info from tag: ${{ github.ref_name }}"
          tag_message=$(git show -s --format=%B ${{ github.ref }})
          pr_info=$(echo "$tag_message" | grep -oP "PR Title: \K.*(?= \| Merged by:)")
          merged_by=$(echo "$tag_message" | grep -oP "Merged by: \K.*$")
          echo "PR_TITLE=$pr_info" >> $GITHUB_ENV
          echo "MERGED_BY=$merged_by" >> $GITHUB_ENV
          echo "Extracted PR Title: $pr_info"
          echo "Merged by: $merged_by"

      - name: Call roo staging tests workflow
        uses: ./.github/actions/test-template
        with:
          environment: staging
          mark: ''
          project: roo
          browser: chrome
          pr_title: ${{ env.PR_TITLE }}
          merged_by: ${{ env.MERGED_BY }}
          gpg_passphrase: ${{ secrets.GPG_PASSPHRASE }}
          gh_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up
        if: always()
        run: |
          sudo rm -rf allure-history allure-report allure-results common/configs/.secrets.yaml
          echo "Clean up completed"
        shell: bash

  # juji-staging-tests:
  #   permissions: write-all
  #   runs-on: juji
  #   if: ${{ github.event.schedule == '0 14 * * *' }}
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Call juji staging tests workflow
  #       uses: ./.github/actions/test-template
  #       with:
  #         environment: staging
  #         mark: ''
  #         project: juji
  #         browser: chrome
  #         gpg_passphrase: ${{ secrets.GPG_PASSPHRASE }}
  #         gh_token: ${{ secrets.GITHUB_TOKEN }}

  #     - name: Clean up
  #       if: always()
  #       run: |
  #         sudo rm -rf allure-history allure-report allure-results common/configs/.secrets.yaml
  #         echo "Clean up completed"
  #       shell: bash

# The production tests will be run on a daily basis until production markers are implemented
#   roo-prod-tests:
#     runs-on: self-hosted
#     if: ${{ github.event.schedule == '0 0 * * *' }}
#     steps:
#       - name: Call roo prod tests workflow
#         uses: ./.github/actions/test-template
#         with:
#           environment: prod
#           mark: ''
#           project: roo
#           browser: chrome
